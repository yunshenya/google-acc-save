<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÆæÂ§á‰ª£Á†ÅÁÆ°ÁêÜ - Ë¥¶Êà∑ÁÆ°ÁêÜÁ≥ªÁªü</title>
    <link href="../static/css/index.css" rel="stylesheet">
    <style>
        .pad-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .pad-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .tabs-container {
            display: flex;
            gap: 2px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-btn {
            padding: 12px 24px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            transform: translateY(2px);
        }

        .tab-btn:hover:not(.active) {
            background: #e9ecef;
            color: #333;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card h3 {
            color: var(--primary-color);
            margin: 0 0 8px 0;
            font-size: 20px;
        }

        .stat-card p {
            color: var(--dark-gray);
            margin: 0;
            font-size: 12px;
        }

        .controls-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            max-width: 300px;
        }

        .filter-select {
            min-width: 120px;
        }

        .selection-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .selected-count {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .pad-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .pad-table th,
        .pad-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pad-table th {
            background-color: #f2f2f2;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .pad-table tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .status-badge {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            color: white;
        }

        .status-active {
            background-color: var(--success-color);
        }

        .status-inactive {
            background-color: var(--danger-color);
        }

        .status-unknown {
            background-color: var(--dark-gray);
        }

        .config-status {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .in-config {
            background-color: #d4edda;
            color: #155724;
        }

        .not-in-config {
            background-color: #f8d7da;
            color: #721c24;
        }

        .device-info {
            font-family: monospace;
            font-size: 11px;
            color: var(--dark-gray);
        }

        .expiration-time {
            font-size: 11px;
            color: var(--warning-color);
        }

        .bulk-actions {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .bulk-actions.show {
            display: block;
        }

        .bulk-actions h4 {
            margin: 0 0 10px 0;
            color: var(--text-color);
        }

        .bulk-action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .comparison-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .comparison-card h4 {
            margin: 0 0 15px 0;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .code-list {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .code-item {
            padding: 2px 0;
            font-family: monospace;
            font-size: 12px;
            color: var(--text-color);
        }

        .sync-recommendations {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--primary-color);
            margin-bottom: 20px;
        }

        .sync-recommendations h4 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
        }

        .danger-zone {
            background: #fff5f5;
            border: 2px solid var(--danger-color);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .danger-zone h4 {
            color: var(--danger-color);
            margin: 0 0 10px 0;
        }

        @media (max-width: 768px) {
            .pad-header {
                flex-direction: column;
                align-items: stretch;
            }

            .action-buttons {
                justify-content: center;
                flex-wrap: wrap;
            }

            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }

            .search-input,
            .filter-select {
                max-width: 100%;
            }

            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .comparison-grid {
                grid-template-columns: 1fr;
            }

            .pad-table th,
            .pad-table td {
                font-size: 11px;
                padding: 8px 4px;
            }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        .refresh-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s ease;
        }

        .refresh-btn:hover {
            background-color: #219a52;
        }

        .refresh-btn:disabled {
            background-color: var(--dark-gray);
            cursor: not-allowed;
        }

        .add-btn {
            background-color: var(--success-color) !important;
        }

        .add-btn:hover {
            background-color: #219a52 !important;
        }

        .remove-btn {
            background-color: var(--danger-color) !important;
        }

        .remove-btn:hover {
            background-color: #c0392b !important;
        }
    </style>
</head>
<body>
<div class="pad-container">
    <div class="pad-header">
        <h1>üì± ËÆæÂ§á‰ª£Á†ÅÁÆ°ÁêÜ</h1>
        <div class="action-buttons">
            <button class="refresh-btn" id="refreshBtn" onclick="loadAvailablePadCodes()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="refreshIcon">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="m3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
                Âà∑Êñ∞‰∫ëÁ´ØÊï∞ÊçÆ
            </button>
            <button class="secondary" onclick="window.location.href='/config'">‚öôÔ∏è ÈÖçÁΩÆÁÆ°ÁêÜ</button>
            <button class="secondary" onclick="window.location.href='/'">ËøîÂõû‰∏ªÈ°µ</button>
        </div>
    </div>

    <!-- ÈîôËØØ/ÊàêÂäüÊ∂àÊÅØ -->
    <div class="error" id="error" style="display: none;">
        <svg fill="currentColor" height="20" viewBox="0 0 20 20" width="20">
            <path clip-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                  fill-rule="evenodd"/>
        </svg>
        <span id="errorMessage"></span>
    </div>

    <div class="error" id="success" style="display: none; background-color: #d4edda; color: #155724;">
        <svg fill="currentColor" height="20" viewBox="0 0 20 20" width="20">
            <path clip-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  fill-rule="evenodd"/>
        </svg>
        <span id="successMessage"></span>
    </div>

    <!-- ÁªüËÆ°‰ø°ÊÅØ -->
    <div class="stats-cards" id="statsCards">
        <!-- ÈÄöËøá JavaScript Âä®ÊÄÅÂ°´ÂÖÖ -->
    </div>

    <!-- Ê†áÁ≠æÈ°µ -->
    <div class="tabs-container">
        <button class="tab-btn active" onclick="switchTab('available')">üåê ‰∫ëÁ´ØÂèØÁî®ËÆæÂ§á</button>
        <button class="tab-btn" onclick="switchTab('compare')">üîç Â∑ÆÂºÇÂØπÊØî</button>
    </div>

    <!-- ‰∫ëÁ´ØÂèØÁî®ËÆæÂ§áÊ†áÁ≠æÈ°µ -->
    <div id="availableTab" class="tab-content active">
        <!-- ÊéßÂà∂Âå∫Âüü -->
        <div class="controls-row">
            <input type="text" class="search-input" id="searchInput" placeholder="ÊêúÁ¥¢ËÆæÂ§á‰ª£Á†Å„ÄÅÂêçÁß∞ÊàñIP...">
            <select class="filter-select" id="statusFilter">
                <option value="">ÊâÄÊúâÁä∂ÊÄÅ</option>
                <option value="1">Âú®Á∫ø</option>
                <option value="0">Á¶ªÁ∫ø</option>
            </select>
            <select class="filter-select" id="configFilter">
                <option value="">ÊâÄÊúâËÆæÂ§á</option>
                <option value="true">Â∑≤Âú®ÈÖçÁΩÆ‰∏≠</option>
                <option value="false">Êú™Âú®ÈÖçÁΩÆ‰∏≠</option>
            </select>
            <button id="applyFilters">Â∫îÁî®Á≠õÈÄâ</button>
            <button class="secondary" id="resetFilters">ÈáçÁΩÆÁ≠õÈÄâ</button>
        </div>

        <!-- ÊâπÈáèÊìç‰ΩúÊéßÂà∂ -->
        <div class="selection-controls">
            <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="selectAll"> ÂÖ®ÈÄâ
            </label>
            <span class="selected-count" id="selectedCount">Â∑≤ÈÄâÊã©: 0</span>
            <button id="selectNotInConfig" class="secondary">ÈÄâÊã©Êú™ÈÖçÁΩÆÁöÑËÆæÂ§á</button>
            <button id="selectOnlineOnly" class="secondary">ÈÄâÊã©Âú®Á∫øËÆæÂ§á</button>
        </div>

        <!-- ÊâπÈáèÊìç‰ΩúÂå∫Âüü -->
        <div class="bulk-actions" id="bulkActions">
            <h4>ÊâπÈáèÊìç‰Ωú</h4>
            <div class="bulk-action-buttons">
                <button onclick="syncSelectedCodes()" class="add-btn">‚úÖ ÂêåÊ≠•ÈÄâ‰∏≠ËÆæÂ§á</button>
                <button onclick="addSelectedCodes()" class="add-btn">‚ûï Ê∑ªÂä†ÈÄâ‰∏≠ËÆæÂ§á</button>
                <button onclick="removeSelectedCodes()" class="remove-btn">‚ûñ ÁßªÈô§ÈÄâ‰∏≠ËÆæÂ§á</button>
            </div>
        </div>

        <!-- ËÆæÂ§áË°®Ê†º -->
        <div class="table-container" style="position: relative;">
            <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                <div class="loading">
                    <svg fill="var(--primary-color)" height="24" style="animation: spin 1s linear infinite;" viewBox="0 0 24 24" width="24">
                        <path d="M12,1A11,11,0,1,0,23,12,11,11,0,0,0,12,1Zm0,19a8,8,0,1,1,8-8A8,8,0,0,1,12,20Z" opacity=".25"/>
                        <path d="M12,4a8,8,0,0,1,7.89,6.7A1.53,1.53,0,0,0,21.38,12h0a1.5,1.5,0,0,0,1.48-1.75,11,11,0,0,0-21.72,0A1.5,1.5,0,0,0,2.62,12h0a1.53,1.53,0,0,0,1.49-1.3A8,8,0,0,1,12,4Z"/>
                    </svg>
                    <div style="margin-left: 10px;">Âä†ËΩΩ‰∏≠...</div>
                </div>
            </div>

            <table class="pad-table" id="availableTable">
                <thead>
                <tr>
                    <th class="checkbox-cell">ÈÄâÊã©</th>
                    <th>ËÆæÂ§á‰ª£Á†Å</th>
                    <th>ËÆæÂ§áÂêçÁß∞</th>
                    <th>Áä∂ÊÄÅ</th>
                    <th>ÈÖçÁΩÆÁä∂ÊÄÅ</th>
                    <th>AndroidÁâàÊú¨</th>
                    <th>ËÆæÂ§á‰ø°ÊÅØ</th>
                    <th>ÈÖçÁΩÆÂêçÁß∞</th>
                    <th>Âà∞ÊúüÊó∂Èó¥</th>
                    <th>ÂêØÂä®Êó∂Èó¥</th>
                </tr>
                </thead>
                <tbody id="availableTableBody">
                <!-- ÈÄöËøá JavaScript Âä®ÊÄÅÂ°´ÂÖÖ -->
                </tbody>
            </table>

            <!-- Á©∫Áä∂ÊÄÅ -->
            <div class="empty-state" id="availableEmptyState" style="display: none;">
                <svg fill="none" height="48" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" width="48">
                    <path d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <h3>ÊöÇÊó†ÂèØÁî®ËÆæÂ§á</h3>
                <p>‰∫ëÁ´ØÊ≤°ÊúâÊâæÂà∞ÂèØÁî®ÁöÑËÆæÂ§á‰ª£Á†Å</p>
            </div>
        </div>

        <!-- Âø´ÈÄüÊìç‰Ωú -->
        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button onclick="syncAllAvailable()" class="add-btn">üîÑ ÂêåÊ≠•ÊâÄÊúâÂèØÁî®ËÆæÂ§á</button>
            <button onclick="syncOnlineOnly()" class="add-btn">üì° ‰ªÖÂêåÊ≠•Âú®Á∫øËÆæÂ§á</button>
            <button onclick="syncNotInConfig()" class="add-btn">üÜï ‰ªÖÂêåÊ≠•Êú™ÈÖçÁΩÆËÆæÂ§á</button>
        </div>
    </div>

    <!-- ÂΩìÂâçÈÖçÁΩÆÊ†áÁ≠æÈ°µ -->
    <div id="currentTab" class="tab-content">
        <div class="controls-row">
            <input type="text" class="search-input" id="currentSearchInput" placeholder="ÊêúÁ¥¢ÂΩìÂâçÈÖçÁΩÆÁöÑËÆæÂ§á‰ª£Á†Å...">
            <button id="applyCurrentFilters">ÊêúÁ¥¢</button>
            <button class="secondary" id="resetCurrentFilters">ÈáçÁΩÆ</button>
        </div>

        <div class="table-container" style="position: relative;">
            <table class="pad-table" id="currentTable">
                <thead>
                <tr>
                    <th class="checkbox-cell">ÈÄâÊã©</th>
                    <th>ËÆæÂ§á‰ª£Á†Å</th>
                    <th>‰∫ëÁ´ØÁä∂ÊÄÅ</th>
                    <th>Êìç‰Ωú</th>
                </tr>
                </thead>
                <tbody id="currentTableBody">
                <!-- ÈÄöËøá JavaScript Âä®ÊÄÅÂ°´ÂÖÖ -->
                </tbody>
            </table>

            <div class="empty-state" id="currentEmptyState" style="display: none;">
                <svg fill="none" height="48" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" width="48">
                    <path d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a6.759 6.759 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <h3>ÊöÇÊó†ÈÖçÁΩÆ</h3>
                <p>ÂΩìÂâçÈÖçÁΩÆ‰∏≠Ê≤°ÊúâËÆæÂ§á‰ª£Á†Å</p>
            </div>
        </div>

        <!-- ÂΩìÂâçÈÖçÁΩÆÊìç‰Ωú -->
        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button onclick="removeSelectedFromConfig()" class="remove-btn">üóëÔ∏è ÁßªÈô§ÈÄâ‰∏≠ËÆæÂ§á</button>
            <button onclick="validateCurrentConfig()" class="secondary">‚úÖ È™åËØÅÈÖçÁΩÆÊúâÊïàÊÄß</button>
        </div>
    </div>

    <!-- Â∑ÆÂºÇÂØπÊØîÊ†áÁ≠æÈ°µ -->
    <div id="compareTab" class="tab-content">
        <div style="margin-bottom: 20px;">
            <button onclick="loadComparison()" class="refresh-btn">üîÑ Âà∑Êñ∞ÂØπÊØîÊï∞ÊçÆ</button>
        </div>

        <!-- ÂØπÊØîÁªüËÆ° -->
        <div class="comparison-grid" id="comparisonGrid">
            <!-- ÈÄöËøá JavaScript Âä®ÊÄÅÂ°´ÂÖÖ -->
        </div>

        <!-- ÂêåÊ≠•Âª∫ËÆÆ -->
        <div class="sync-recommendations" id="syncRecommendations" style="display: none;">
            <!-- ÈÄöËøá JavaScript Âä®ÊÄÅÂ°´ÂÖÖ -->
        </div>

        <!-- Âç±Èô©Êìç‰ΩúÂå∫Âüü -->
        <div class="danger-zone">
            <h4>‚ö†Ô∏è Âç±Èô©Êìç‰Ωú</h4>
            <p>‰ª•‰∏ãÊìç‰Ωú‰ºöÂÆåÂÖ®ÊõøÊç¢ÂΩìÂâçÈÖçÁΩÆÔºåËØ∑Ë∞®ÊÖé‰ΩøÁî®Ôºö</p>
            <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="replaceWithCloudCodes()" class="remove-btn">üîÑ Áî®‰∫ëÁ´Ø‰ª£Á†ÅÂÆåÂÖ®ÊõøÊç¢Êú¨Âú∞ÈÖçÁΩÆ</button>
                <button onclick="clearAllCodes()" class="remove-btn">üóëÔ∏è Ê∏ÖÁ©∫ÊâÄÊúâËÆæÂ§á‰ª£Á†Å</button>
            </div>
        </div>
    </div>
</div>

<script>
    let availablePadCodes = [];
    let currentPadCodes = [];
    let filteredAvailableCodes = [];
    let selectedCodes = new Set();
    let currentTab = 'available';

    // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', function() {
        checkAuthStatus().then(() => {
            loadAvailablePadCodes();
            loadCurrentPadCodes();
            setupEventListeners();
        });
    });

    // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
    function setupEventListeners() {
        document.getElementById('applyFilters').addEventListener('click', applyFilters);
        document.getElementById('resetFilters').addEventListener('click', resetFilters);
        document.getElementById('searchInput').addEventListener('keyup', debounce(applyFilters, 300));
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
        document.getElementById('configFilter').addEventListener('change', applyFilters);

        document.getElementById('selectAll').addEventListener('change', toggleSelectAll);
        document.getElementById('selectNotInConfig').addEventListener('click', selectNotInConfig);
        document.getElementById('selectOnlineOnly').addEventListener('click', selectOnlineOnly);

        document.getElementById('applyCurrentFilters').addEventListener('click', applyCurrentFilters);
        document.getElementById('resetCurrentFilters').addEventListener('click', resetCurrentFilters);
        document.getElementById('currentSearchInput').addEventListener('keyup', debounce(applyCurrentFilters, 300));
    }

    // ËÆ§ËØÅÊ£ÄÊü•
    async function checkAuthStatus() {
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        try {
            const response = await fetch('/auth/verify', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                window.location.href = '/login';
            }
        } catch (error) {
            console.error('ËÆ§ËØÅÊ£ÄÊü•Â§±Ë¥•:', error);
            window.location.href = '/login';
        }
    }

    // Ëé∑ÂèñËÆ§ËØÅÂ§¥
    function getAuthHeaders() {
        const token = localStorage.getItem('access_token');
        return {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };
    }

    // ÂàáÊç¢Ê†áÁ≠æÈ°µ
    function switchTab(tabName) {
        // ÈöêËóèÊâÄÊúâÊ†áÁ≠æÂÜÖÂÆπ
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });

        // ÁßªÈô§ÊâÄÊúâÊåâÈíÆÁöÑÊ¥ªË∑ÉÁä∂ÊÄÅ
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // ÊòæÁ§∫ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÂÜÖÂÆπ
        document.getElementById(tabName + 'Tab').classList.add('active');

        // ÊøÄÊ¥ªÂØπÂ∫îÊåâÈíÆ
        event.target.classList.add('active');

        currentTab = tabName;

        // Ê†πÊçÆÊ†áÁ≠æÈ°µÂä†ËΩΩÂØπÂ∫îÊï∞ÊçÆ
        if (tabName === 'current') {
            loadCurrentPadCodes();
        } else if (tabName === 'compare') {
            loadComparison();
        }
    }

    // Âä†ËΩΩ‰∫ëÁ´ØÂèØÁî®ËÆæÂ§á
    async function loadAvailablePadCodes() {
        const refreshBtn = document.getElementById('refreshBtn');
        const refreshIcon = document.getElementById('refreshIcon');
        const loadingOverlay = document.getElementById('loadingOverlay');

        try {
            refreshBtn.disabled = true;
            refreshIcon.classList.add('loading-spinner');
            loadingOverlay.style.display = 'flex';
            hideMessages();

            const response = await fetch('/api/pad-codes/available', {
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                throw new Error(`HTTPÈîôËØØ! Áä∂ÊÄÅÁ†Å: ${response.status}`);
            }

            const result = await response.json();
            availablePadCodes = result.data || [];
            filteredAvailableCodes = [...availablePadCodes];

            updateStatsCards(result.summary);
            renderAvailableTable();
            updateSelectedCount();

        } catch (error) {
            console.error('Âä†ËΩΩ‰∫ëÁ´ØËÆæÂ§áÂ§±Ë¥•:', error);
            showError('Âä†ËΩΩ‰∫ëÁ´ØËÆæÂ§áÂ§±Ë¥•: ' + error.message);
        } finally {
            refreshBtn.disabled = false;
            refreshIcon.classList.remove('loading-spinner');
            loadingOverlay.style.display = 'none';
        }
    }

    // Âä†ËΩΩÂΩìÂâçÈÖçÁΩÆ
    async function loadCurrentPadCodes() {
        try {
            const response = await fetch('/api/pad-codes/current', {
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                throw new Error(`Ëé∑ÂèñÂΩìÂâçÈÖçÁΩÆÂ§±Ë¥•: ${response.status}`);
            }

            const result = await response.json();
            currentPadCodes = result.data || [];
            renderCurrentTable();

        } catch (error) {
            console.error('Âä†ËΩΩÂΩìÂâçÈÖçÁΩÆÂ§±Ë¥•:', error);
            showError('Âä†ËΩΩÂΩìÂâçÈÖçÁΩÆÂ§±Ë¥•: ' + error.message);
        }
    }

    // Êõ¥Êñ∞ÁªüËÆ°Âç°Áâá
    function updateStatsCards(summary) {
        const statsCards = document.getElementById('statsCards');

        if (!summary) {
            statsCards.innerHTML = '';
            return;
        }

        statsCards.innerHTML = `
            <div class="stat-card">
                <h3>${summary.total_available}</h3>
                <p>‰∫ëÁ´ØÂèØÁî®ËÆæÂ§á</p>
            </div>
            <div class="stat-card">
                <h3>${summary.total_in_config}</h3>
                <p>ÂΩìÂâçÈÖçÁΩÆËÆæÂ§á</p>
            </div>
            <div class="stat-card">
                <h3>${summary.not_in_config}</h3>
                <p>Êú™ÈÖçÁΩÆËÆæÂ§á</p>
            </div>
            <div class="stat-card">
                <h3>${summary.config_not_available}</h3>
                <p>ÈÖçÁΩÆ‰∏≠‰ΩÜ‰∫ëÁ´Ø‰∏çÂèØÁî®</p>
            </div>
        `;
    }

    // Ê∏≤ÊüìÂèØÁî®ËÆæÂ§áË°®Ê†º
    function renderAvailableTable() {
        const tableBody = document.getElementById('availableTableBody');
        const emptyState = document.getElementById('availableEmptyState');

        if (filteredAvailableCodes.length === 0) {
            tableBody.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';

        const rows = filteredAvailableCodes.map(pad => {
            const isSelected = selectedCodes.has(pad.padCode);
            const statusBadge = pad.status === 1 ?
                '<span class="status-badge status-active">Âú®Á∫ø</span>' :
                '<span class="status-badge status-inactive">Á¶ªÁ∫ø</span>';

            const configBadge = pad.isInConfig ?
                '<span class="config-status in-config">Â∑≤ÈÖçÁΩÆ</span>' :
                '<span class="config-status not-in-config">Êú™ÈÖçÁΩÆ</span>';

            return `
                <tr>
                    <td class="checkbox-cell">
                        <input type="checkbox" ${isSelected ? 'checked' : ''}
                               onchange="toggleSelection('${pad.padCode}')"
                               value="${pad.padCode}">
                    </td>
                    <td title="${pad.padCode}">${pad.padCode}</td>
                    <td>${pad.padName || 'Êú™ÂëΩÂêç'}</td>
                    <td>${statusBadge}</td>
                    <td>${configBadge}</td>
                    <td>Android ${pad.androidVersion || 'Êú™Áü•'}</td>
                    <td class="device-info">
                        ËÆæÂ§áIP: ${pad.deviceIp || 'Êú™Áü•'}<br>
                        Pad IP: ${pad.padIp || 'Êú™Áü•'}
                    </td>
                    <td>${pad.goodName || 'Êú™ËÆæÁΩÆ'}</td>
                    <td class="expiration-time">${pad.signExpirationTime || 'Êú™Áü•'}</td>
                    <td>${formatTimestamp(pad.bootTime)}</td>
                </tr>
            `;
        }).join('');

        tableBody.innerHTML = rows;
    }

    // Ê∏≤ÊüìÂΩìÂâçÈÖçÁΩÆË°®Ê†º
    function renderCurrentTable() {
        const tableBody = document.getElementById('currentTableBody');
        const emptyState = document.getElementById('currentEmptyState');

        if (currentPadCodes.length === 0) {
            tableBody.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';

        const rows = currentPadCodes.map(code => {
            const cloudDevice = availablePadCodes.find(pad => pad.padCode === code);
            const cloudStatus = cloudDevice ?
                (cloudDevice.status === 1 ?
                    '<span class="status-badge status-active">‰∫ëÁ´ØÂú®Á∫ø</span>' :
                    '<span class="status-badge status-inactive">‰∫ëÁ´ØÁ¶ªÁ∫ø</span>') :
                '<span class="status-badge status-unknown">‰∫ëÁ´Ø‰∏çÂ≠òÂú®</span>';

            return `
                <tr>
                    <td class="checkbox-cell">
                        <input type="checkbox" value="${code}" onchange="toggleCurrentSelection('${code}')">
                    </td>
                    <td title="${code}">${code}</td>
                    <td>${cloudStatus}</td>
                    <td>
                        <button class="remove-btn" onclick="removeSingleCode('${code}')">ÁßªÈô§</button>
                    </td>
                </tr>
            `;
        }).join('');

        tableBody.innerHTML = rows;
    }

    // ÂàáÊç¢ÈÄâÊã©Áä∂ÊÄÅ
    function toggleSelection(padCode) {
        if (selectedCodes.has(padCode)) {
            selectedCodes.delete(padCode);
        } else {
            selectedCodes.add(padCode);
        }
        updateSelectedCount();
        updateBulkActions();
    }

    // ÂàáÊç¢ÂÖ®ÈÄâ
    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('#availableTableBody input[type="checkbox"]');

        if (selectAllCheckbox.checked) {
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                selectedCodes.add(checkbox.value);
            });
        } else {
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                selectedCodes.delete(checkbox.value);
            });
        }

        updateSelectedCount();
        updateBulkActions();
    }

    // ÈÄâÊã©Êú™ÈÖçÁΩÆÁöÑËÆæÂ§á
    function selectNotInConfig() {
        selectedCodes.clear();
        filteredAvailableCodes.forEach(pad => {
            if (!pad.isInConfig) {
                selectedCodes.add(pad.padCode);
            }
        });
        renderAvailableTable();
        updateSelectedCount();
        updateBulkActions();
    }

    // ÈÄâÊã©Âú®Á∫øËÆæÂ§á
    function selectOnlineOnly() {
        selectedCodes.clear();
        filteredAvailableCodes.forEach(pad => {
            if (pad.status === 1) {
                selectedCodes.add(pad.padCode);
            }
        });
        renderAvailableTable();
        updateSelectedCount();
        updateBulkActions();
    }

    // Êõ¥Êñ∞ÈÄâÊã©ËÆ°Êï∞
    function updateSelectedCount() {
        const countElement = document.getElementById('selectedCount');
        if (countElement) {
            countElement.textContent = `Â∑≤ÈÄâÊã©: ${selectedCodes.size}`;
        }
    }

    // Êõ¥Êñ∞ÊâπÈáèÊìç‰ΩúÂå∫Âüü
    function updateBulkActions() {
        const bulkActions = document.getElementById('bulkActions');
        if (selectedCodes.size > 0) {
            bulkActions.classList.add('show');
        } else {
            bulkActions.classList.remove('show');
        }
    }

    // Â∫îÁî®Á≠õÈÄâ
    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const configFilter = document.getElementById('configFilter').value;

        filteredAvailableCodes = availablePadCodes.filter(pad => {
            const matchesSearch = !searchTerm ||
                (pad.padCode && pad.padCode.toLowerCase().includes(searchTerm)) ||
                (pad.padName && pad.padName.toLowerCase().includes(searchTerm)) ||
                (pad.deviceIp && pad.deviceIp.toLowerCase().includes(searchTerm)) ||
                (pad.padIp && pad.padIp.toLowerCase().includes(searchTerm));

            const matchesStatus = !statusFilter || pad.status.toString() === statusFilter;
            const matchesConfig = !configFilter || pad.isInConfig.toString() === configFilter;

            return matchesSearch && matchesStatus && matchesConfig;
        });

        renderAvailableTable();
    }

    // ÈáçÁΩÆÁ≠õÈÄâ
    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('configFilter').value = '';
        filteredAvailableCodes = [...availablePadCodes];
        renderAvailableTable();
    }

    // ÂêåÊ≠•ÈÄâ‰∏≠ÁöÑËÆæÂ§á‰ª£Á†Å
    async function syncSelectedCodes() {
        if (selectedCodes.size === 0) {
            showError('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂêåÊ≠•ÁöÑËÆæÂ§á');
            return;
        }

        if (!confirm(`Á°ÆÂÆöË¶ÅÂêåÊ≠•ÈÄâ‰∏≠ÁöÑ ${selectedCodes.size} ‰∏™ËÆæÂ§á‰ª£Á†ÅÂêóÔºü`)) {
            return;
        }

        try {
            showLoading(true);

            const response = await fetch('/api/pad-codes/sync', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    selected_codes: Array.from(selectedCodes)
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'ÂêåÊ≠•Â§±Ë¥•');
            }

            const result = await response.json();
            showSuccess(result.message);

            // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            selectedCodes.clear();
            await loadAvailablePadCodes();
            await loadCurrentPadCodes();

        } catch (error) {
            console.error('ÂêåÊ≠•Â§±Ë¥•:', error);
            showError('ÂêåÊ≠•Â§±Ë¥•: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // Ê∑ªÂä†ÈÄâ‰∏≠ÁöÑËÆæÂ§á‰ª£Á†Å
    async function addSelectedCodes() {
        if (selectedCodes.size === 0) {
            showError('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊ∑ªÂä†ÁöÑËÆæÂ§á');
            return;
        }

        try {
            showLoading(true);

            const response = await fetch('/api/pad-codes/add', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    selected_codes: Array.from(selectedCodes)
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Ê∑ªÂä†Â§±Ë¥•');
            }

            const result = await response.json();
            showSuccess(result.message);

            // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            selectedCodes.clear();
            await loadAvailablePadCodes();
            await loadCurrentPadCodes();

        } catch (error) {
            console.error('Ê∑ªÂä†Â§±Ë¥•:', error);
            showError('Ê∑ªÂä†Â§±Ë¥•: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // ÁßªÈô§ÈÄâ‰∏≠ÁöÑËÆæÂ§á‰ª£Á†Å
    async function removeSelectedCodes() {
        if (selectedCodes.size === 0) {
            showError('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÁßªÈô§ÁöÑËÆæÂ§á');
            return;
        }

        if (!confirm(`Á°ÆÂÆöË¶Å‰ªéÈÖçÁΩÆ‰∏≠ÁßªÈô§ÈÄâ‰∏≠ÁöÑ ${selectedCodes.size} ‰∏™ËÆæÂ§á‰ª£Á†ÅÂêóÔºü`)) {
            return;
        }

        try {
            showLoading(true);

            const response = await fetch('/api/pad-codes/remove', {
                method: 'DELETE',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    selected_codes: Array.from(selectedCodes)
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'ÁßªÈô§Â§±Ë¥•');
            }

            const result = await response.json();
            showSuccess(result.message);

            // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            selectedCodes.clear();
            await loadAvailablePadCodes();
            await loadCurrentPadCodes();

        } catch (error) {
            console.error('ÁßªÈô§Â§±Ë¥•:', error);
            showError('ÁßªÈô§Â§±Ë¥•: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // ÂêåÊ≠•ÊâÄÊúâÂèØÁî®ËÆæÂ§á
    async function syncAllAvailable() {
        if (!confirm('Á°ÆÂÆöË¶ÅÂêåÊ≠•ÊâÄÊúâ‰∫ëÁ´ØÂèØÁî®ÁöÑËÆæÂ§á‰ª£Á†ÅÂêóÔºüËøôÂ∞ÜÊ∑ªÂä†ÊâÄÊúâ‰∫ëÁ´ØËÆæÂ§áÂà∞ÈÖçÁΩÆ‰∏≠„ÄÇ')) {
            return;
        }

        try {
            showLoading(true);

            const response = await fetch('/api/pad-codes/sync', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    selected_codes: []  // Á©∫Êï∞ÁªÑË°®Á§∫ÂêåÊ≠•ÊâÄÊúâ
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'ÂêåÊ≠•Â§±Ë¥•');
            }

            const result = await response.json();
            showSuccess(result.message);

            // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            await loadAvailablePadCodes();
            await loadCurrentPadCodes();

        } catch (error) {
            console.error('ÂêåÊ≠•Â§±Ë¥•:', error);
            showError('ÂêåÊ≠•Â§±Ë¥•: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // ‰ªÖÂêåÊ≠•Âú®Á∫øËÆæÂ§á
    async function syncOnlineOnly() {
        const onlineCodes = availablePadCodes
            .filter(pad => pad.status === 1)
            .map(pad => pad.padCode);

        if (onlineCodes.length === 0) {
            showError('Ê≤°ÊúâÂú®Á∫øÁöÑËÆæÂ§áÂèØÂêåÊ≠•');
            return;
        }

        if (!confirm(`Á°ÆÂÆöË¶ÅÂêåÊ≠• ${onlineCodes.length} ‰∏™Âú®Á∫øËÆæÂ§áÂêóÔºü`)) {
            return;
        }

        try {
            showLoading(true);

            const response = await fetch('/api/pad-codes/sync', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    selected_codes: onlineCodes
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'ÂêåÊ≠•Â§±Ë¥•');
            }

            const result = await response.json();
            showSuccess(result.message);

            // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            await loadAvailablePadCodes();
            await loadCurrentPadCodes();

        } catch (error) {
            console.error('ÂêåÊ≠•Âú®Á∫øËÆæÂ§áÂ§±Ë¥•:', error);
            showError('ÂêåÊ≠•Âú®Á∫øËÆæÂ§áÂ§±Ë¥•: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // ‰ªÖÂêåÊ≠•Êú™ÈÖçÁΩÆËÆæÂ§á
    async function syncNotInConfig() {
        const notConfiguredCodes = availablePadCodes
            .filter(pad => !pad.isInConfig)
            .map(pad => pad.padCode);

        if (notConfiguredCodes.length === 0) {
            showError('Ê≤°ÊúâÊú™ÈÖçÁΩÆÁöÑËÆæÂ§áÂèØÂêåÊ≠•');
            return;
        }

        if (!confirm(`Á°ÆÂÆöË¶ÅÂêåÊ≠• ${notConfiguredCodes.length} ‰∏™Êú™ÈÖçÁΩÆÁöÑËÆæÂ§áÂêóÔºü`)) {
            return;
        }

        try {
            showLoading(true);

            const response = await fetch('/api/pad-codes/add', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    selected_codes: notConfiguredCodes
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'ÂêåÊ≠•Â§±Ë¥•');
            }

            const result = await response.json();
            showSuccess(result.message);

            // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            await loadAvailablePadCodes();
            await loadCurrentPadCodes();

        } catch (error) {
            console.error('ÂêåÊ≠•Êú™ÈÖçÁΩÆËÆæÂ§áÂ§±Ë¥•:', error);
            showError('ÂêåÊ≠•Êú™ÈÖçÁΩÆËÆæÂ§áÂ§±Ë¥•: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // ÂΩìÂâçÈÖçÁΩÆÁ≠õÈÄâ
    function applyCurrentFilters() {
        const searchTerm = document.getElementById('currentSearchInput').value.toLowerCase();
        // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂΩìÂâçÈÖçÁΩÆÁöÑÁ≠õÈÄâÈÄªËæë
        renderCurrentTable();
    }

    function resetCurrentFilters() {
        document.getElementById('currentSearchInput').value = '';
        renderCurrentTable();
    }

    // ÂàáÊç¢ÂΩìÂâçÈÖçÁΩÆÈÄâÊã©
    function toggleCurrentSelection(code) {
        // ÂΩìÂâçÈÖçÁΩÆÁöÑÈÄâÊã©ÈÄªËæë
    }

    // ‰ªéÈÖçÁΩÆ‰∏≠ÁßªÈô§ÈÄâ‰∏≠ËÆæÂ§á
    async function removeSelectedFromConfig() {
        const checkboxes = document.querySelectorAll('#currentTableBody input[type="checkbox"]:checked');
        const selectedCurrentCodes = Array.from(checkboxes).map(cb => cb.value);

        if (selectedCurrentCodes.length === 0) {
            showError('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÁßªÈô§ÁöÑËÆæÂ§á');
            return;
        }

        if (!confirm(`Á°ÆÂÆöË¶Å‰ªéÈÖçÁΩÆ‰∏≠ÁßªÈô§ÈÄâ‰∏≠ÁöÑ ${selectedCurrentCodes.length} ‰∏™ËÆæÂ§áÂêóÔºü`)) {
            return;
        }

        try {
            showLoading(true);

            const response = await fetch('/api/pad-codes/remove', {
                method: 'DELETE',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    selected_codes: selectedCurrentCodes
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'ÁßªÈô§Â§±Ë¥•');
            }

            const result = await response.json();
            showSuccess(result.message);

            // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            await loadAvailablePadCodes();
            await loadCurrentPadCodes();

        } catch (error) {
            console.error('ÁßªÈô§Â§±Ë¥•:', error);
            showError('ÁßªÈô§Â§±Ë¥•: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // ÁßªÈô§Âçï‰∏™ËÆæÂ§á‰ª£Á†Å
    async function removeSingleCode(code) {
        if (!confirm(`Á°ÆÂÆöË¶ÅÁßªÈô§ËÆæÂ§á‰ª£Á†Å "${code}" ÂêóÔºü`)) {
            return;
        }

        try {
            showLoading(true);

            const response = await fetch('/api/pad-codes/remove', {
                method: 'DELETE',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    selected_codes: [code]
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'ÁßªÈô§Â§±Ë¥•');
            }

            const result = await response.json();
            showSuccess(result.message);

            // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            await loadAvailablePadCodes();
            await loadCurrentPadCodes();

        } catch (error) {
            console.error('ÁßªÈô§Â§±Ë¥•:', error);
            showError('ÁßªÈô§Â§±Ë¥•: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // È™åËØÅÂΩìÂâçÈÖçÁΩÆÊúâÊïàÊÄß
    async function validateCurrentConfig() {
        try {
            showLoading(true);

            const response = await fetch('/api/pad-codes/compare', {
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                throw new Error('È™åËØÅÂ§±Ë¥•');
            }

            const result = await response.json();

            let message = `ÈÖçÁΩÆÈ™åËØÅÁªìÊûúÔºö\n`;
            message += `‰∫ëÁ´ØÊÄªËÆæÂ§á: ${result.cloud_total}\n`;
            message += `Êú¨Âú∞ÈÖçÁΩÆ: ${result.local_total}\n`;
            message += `ÊúâÊïàÈÖçÁΩÆ: ${result.in_both}\n`;
            message += `Êó†ÊïàÈÖçÁΩÆ: ${result.only_in_local.count}\n`;
            message += `ÂèØÊ∑ªÂä†ËÆæÂ§á: ${result.only_in_cloud.count}`;

            if (result.only_in_local.count > 0) {
                message += `\n\nÊó†ÊïàËÆæÂ§á‰ª£Á†Å: ${result.only_in_local.codes.join(', ')}`;
            }

            alert(message);

        } catch (error) {
            console.error('È™åËØÅÂ§±Ë¥•:', error);
            showError('È™åËØÅÂ§±Ë¥•: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // Âä†ËΩΩÂØπÊØîÊï∞ÊçÆ
    async function loadComparison() {
        try {
            showLoading(true);

            const response = await fetch('/api/pad-codes/compare', {
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                throw new Error('Ëé∑ÂèñÂØπÊØîÊï∞ÊçÆÂ§±Ë¥•');
            }

            const result = await response.json();
            renderComparisonData(result);

        } catch (error) {
            console.error('Âä†ËΩΩÂØπÊØîÊï∞ÊçÆÂ§±Ë¥•:', error);
            showError('Âä†ËΩΩÂØπÊØîÊï∞ÊçÆÂ§±Ë¥•: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // Ê∏≤ÊüìÂØπÊØîÊï∞ÊçÆ
    function renderComparisonData(data) {
        const comparisonGrid = document.getElementById('comparisonGrid');
        const syncRecommendations = document.getElementById('syncRecommendations');

        comparisonGrid.innerHTML = `
            <div class="comparison-card">
                <h4>üìä ÁªüËÆ°ÊÄªËßà</h4>
                <div class="metric-row">
                    <span class="metric-label">‰∫ëÁ´ØÊÄªËÆæÂ§á</span>
                    <span class="metric-value">${data.cloud_total}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Êú¨Âú∞ÈÖçÁΩÆËÆæÂ§á</span>
                    <span class="metric-value">${data.local_total}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">ÊúâÊïàÈÖçÁΩÆ</span>
                    <span class="metric-value positive">${data.in_both}</span>
                </div>
            </div>

            <div class="comparison-card">
                <h4>üÜï ÂèØÊ∑ªÂä†ËÆæÂ§á (${data.only_in_cloud.count})</h4>
                <div class="code-list">
                    ${data.only_in_cloud.codes.length > 0 ?
            data.only_in_cloud.codes.map(code =>
                `<div class="code-item">${code}</div>`
            ).join('') :
            '<div class="code-item">Êó†</div>'
        }
                </div>
                ${data.only_in_cloud.count > 0 ?
            `<button onclick="addCloudOnlyCodes()" class="add-btn" style="margin-top: 10px;">Ê∑ªÂä†Ëøô‰∫õËÆæÂ§á</button>` :
            ''
        }
            </div>

            <div class="comparison-card">
                <h4>‚ö†Ô∏è Êó†ÊïàÈÖçÁΩÆ (${data.only_in_local.count})</h4>
                <div class="code-list">
                    ${data.only_in_local.codes.length > 0 ?
            data.only_in_local.codes.map(code =>
                `<div class="code-item">${code}</div>`
            ).join('') :
            '<div class="code-item">Êó†</div>'
        }
                </div>
                ${data.only_in_local.count > 0 ?
            `<button onclick="removeInvalidCodes()" class="remove-btn" style="margin-top: 10px;">ÁßªÈô§Ëøô‰∫õËÆæÂ§á</button>` :
            ''
        }
            </div>
        `;

        // ÊòæÁ§∫ÂêåÊ≠•Âª∫ËÆÆ
        if (data.only_in_cloud.count > 0 || data.only_in_local.count > 0) {
            syncRecommendations.style.display = 'block';
            syncRecommendations.innerHTML = `
                <h4>üîÑ ÂêåÊ≠•Âª∫ËÆÆ</h4>
                <p>
                    Âª∫ËÆÆÊÇ®Ôºö
                    ${data.only_in_cloud.count > 0 ? `Ê∑ªÂä† ${data.only_in_cloud.count} ‰∏™‰∫ëÁ´ØÊñ∞ËÆæÂ§áÂà∞ÈÖçÁΩÆ‰∏≠Ôºõ` : ''}
                    ${data.only_in_local.count > 0 ? `ÁßªÈô§ ${data.only_in_local.count} ‰∏™Êó†ÊïàÁöÑÈÖçÁΩÆËÆæÂ§á„ÄÇ` : ''}
                </p>
                <div style="margin-top: 10px;">
                    ${data.only_in_cloud.count > 0 && data.only_in_local.count > 0 ?
                `<button onclick="autoSync()" class="add-btn">üîÑ Ëá™Âä®ÂêåÊ≠•ÔºàÊ∑ªÂä†Êñ∞ËÆæÂ§á+ÁßªÈô§Êó†ÊïàËÆæÂ§áÔºâ</button>` :
                ''
            }
                </div>
            `;
        } else {
            syncRecommendations.style.display = 'none';
        }
    }

    // Ê∑ªÂä†‰ªÖ‰∫ëÁ´ØÂ≠òÂú®ÁöÑËÆæÂ§á
    async function addCloudOnlyCodes() {
        // ÈáçÊñ∞Ëé∑ÂèñÊúÄÊñ∞ÁöÑÂØπÊØîÊï∞ÊçÆ
        const response = await fetch('/api/pad-codes/compare', {
            headers: getAuthHeaders()
        });
        const data = await response.json();

        if (data.only_in_cloud.codes.length === 0) {
            showError('Ê≤°ÊúâÂèØÊ∑ªÂä†ÁöÑËÆæÂ§á');
            return;
        }

        if (!confirm(`Á°ÆÂÆöË¶ÅÊ∑ªÂä† ${data.only_in_cloud.codes.length} ‰∏™‰∫ëÁ´ØËÆæÂ§áÂà∞ÈÖçÁΩÆ‰∏≠ÂêóÔºü`)) {
            return;
        }

        try {
            showLoading(true);

            const response = await fetch('/api/pad-codes/add', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    selected_codes: data.only_in_cloud.codes
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Ê∑ªÂä†Â§±Ë¥•');
            }

            const result = await response.json();
            showSuccess(result.message);

            // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            await loadAvailablePadCodes();
            await loadCurrentPadCodes();
            await loadComparison();

        } catch (error) {
            console.error('Ê∑ªÂä†Â§±Ë¥•:', error);
            showError('Ê∑ªÂä†Â§±Ë¥•: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // ÁßªÈô§Êó†ÊïàÁöÑËÆæÂ§á‰ª£Á†Å
    async function removeInvalidCodes() {
        // ÈáçÊñ∞Ëé∑ÂèñÊúÄÊñ∞ÁöÑÂØπÊØîÊï∞ÊçÆ
        const response = await fetch('/api/pad-codes/compare', {
            headers: getAuthHeaders()
        });
        const data = await response.json();

        if (data.only_in_local.codes.length === 0) {
            showError('Ê≤°ÊúâÊó†ÊïàÁöÑËÆæÂ§áÈúÄË¶ÅÁßªÈô§');
            return;
        }

        if (!confirm(`Á°ÆÂÆöË¶ÅÁßªÈô§ ${data.only_in_local.codes.length} ‰∏™Êó†ÊïàÁöÑËÆæÂ§á‰ª£Á†ÅÂêóÔºü\n\nËøô‰∫õËÆæÂ§áÂú®‰∫ëÁ´Ø‰∏çÂ≠òÂú®Ôºö\n${data.only_in_local.codes.join('\n')}`)) {
            return;
        }

        try {
            showLoading(true);

            const response = await fetch('/api/pad-codes/remove', {
                method: 'DELETE',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    selected_codes: data.only_in_local.codes
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'ÁßªÈô§Â§±Ë¥•');
            }

            const result = await response.json();
            showSuccess(result.message);

            // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            await loadAvailablePadCodes();
            await loadCurrentPadCodes();
            await loadComparison();

        } catch (error) {
            console.error('ÁßªÈô§Â§±Ë¥•:', error);
            showError('ÁßªÈô§Â§±Ë¥•: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // Ëá™Âä®ÂêåÊ≠•
    async function autoSync() {
        if (!confirm('Á°ÆÂÆöË¶ÅÊâßË°åËá™Âä®ÂêåÊ≠•ÂêóÔºü\n\nËøôÂ∞ÜÔºö\n1. Ê∑ªÂä†‰∫ëÁ´ØÂ≠òÂú®‰ΩÜÊú¨Âú∞Êú™ÈÖçÁΩÆÁöÑËÆæÂ§á\n2. ÁßªÈô§Êú¨Âú∞ÈÖçÁΩÆ‰ΩÜ‰∫ëÁ´Ø‰∏çÂ≠òÂú®ÁöÑËÆæÂ§á')) {
            return;
        }

        try {
            showLoading(true);

            // Ëé∑ÂèñÊúÄÊñ∞ÂØπÊØîÊï∞ÊçÆ
            const compareResponse = await fetch('/api/pad-codes/compare', {
                headers: getAuthHeaders()
            });
            const compareData = await compareResponse.json();

            let successMessages = [];

            // ÂÖàÊ∑ªÂä†Êñ∞ËÆæÂ§á
            if (compareData.only_in_cloud.codes.length > 0) {
                const addResponse = await fetch('/api/pad-codes/add', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        selected_codes: compareData.only_in_cloud.codes
                    })
                });

                if (addResponse.ok) {
                    const addResult = await addResponse.json();
                    successMessages.push(`Ê∑ªÂä†: ${addResult.message}`);
                }
            }

            // ÂÜçÁßªÈô§Êó†ÊïàËÆæÂ§á
            if (compareData.only_in_local.codes.length > 0) {
                const removeResponse = await fetch('/api/pad-codes/remove', {
                    method: 'DELETE',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        selected_codes: compareData.only_in_local.codes
                    })
                });

                if (removeResponse.ok) {
                    const removeResult = await removeResponse.json();
                    successMessages.push(`ÁßªÈô§: ${removeResult.message}`);
                }
            }

            if (successMessages.length > 0) {
                showSuccess('Ëá™Âä®ÂêåÊ≠•ÂÆåÊàêÔºÅ\n' + successMessages.join('\n'));
            }

            // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            await loadAvailablePadCodes();
            await loadCurrentPadCodes();
            await loadComparison();

        } catch (error) {
            console.error('Ëá™Âä®ÂêåÊ≠•Â§±Ë¥•:', error);
            showError('Ëá™Âä®ÂêåÊ≠•Â§±Ë¥•: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // Âç±Èô©Êìç‰ΩúÔºöÁî®‰∫ëÁ´Ø‰ª£Á†ÅÂÆåÂÖ®ÊõøÊç¢Êú¨Âú∞ÈÖçÁΩÆ
    async function replaceWithCloudCodes() {
        if (!confirm('‚ö†Ô∏è Âç±Èô©Êìç‰ΩúË≠¶ÂëäÔºÅ\n\nËøôÂ∞ÜÁî®‰∫ëÁ´ØÁöÑÊâÄÊúâËÆæÂ§á‰ª£Á†ÅÂÆåÂÖ®ÊõøÊç¢ÂΩìÂâçÈÖçÁΩÆÔºåÂéüÊúâÈÖçÁΩÆÂ∞Ü‰∏¢Â§±ÔºÅ\n\nÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü')) {
            return;
        }

        if (!confirm('ÊúÄÂêéÁ°ÆËÆ§ÔºöÊÇ®Á°ÆÂÆöË¶ÅÁî®‰∫ëÁ´ØËÆæÂ§á‰ª£Á†ÅÂÆåÂÖ®ÊõøÊç¢ÂΩìÂâçÈÖçÁΩÆÂêóÔºü\n\nÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ')) {
            return;
        }

        try {
            showLoading(true);

            const cloudCodes = availablePadCodes.map(pad => pad.padCode);

            const response = await fetch('/api/pad-codes/replace', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    selected_codes: cloudCodes
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'ÊõøÊç¢Â§±Ë¥•');
            }

            const result = await response.json();
            showSuccess(result.message);

            // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            selectedCodes.clear();
            await loadAvailablePadCodes();
            await loadCurrentPadCodes();

        } catch (error) {
            console.error('ÊõøÊç¢Â§±Ë¥•:', error);
            showError('ÊõøÊç¢Â§±Ë¥•: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // Âç±Èô©Êìç‰ΩúÔºöÊ∏ÖÁ©∫ÊâÄÊúâËÆæÂ§á‰ª£Á†Å
    async function clearAllCodes() {
        if (!confirm('‚ö†Ô∏è Âç±Èô©Êìç‰ΩúË≠¶ÂëäÔºÅ\n\nËøôÂ∞ÜÊ∏ÖÁ©∫ÊâÄÊúâËÆæÂ§á‰ª£Á†ÅÈÖçÁΩÆÔºÅ\n\nÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü')) {
            return;
        }

        if (!confirm('ÊúÄÂêéÁ°ÆËÆ§ÔºöÊÇ®Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâËÆæÂ§á‰ª£Á†ÅÂêóÔºü\n\nÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ')) {
            return;
        }

        try {
            showLoading(true);

            const response = await fetch('/api/pad-codes/replace', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    selected_codes: []
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Ê∏ÖÁ©∫Â§±Ë¥•');
            }

            showSuccess('ÊâÄÊúâËÆæÂ§á‰ª£Á†ÅÂ∑≤Ê∏ÖÁ©∫');

            // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            selectedCodes.clear();
            await loadAvailablePadCodes();
            await loadCurrentPadCodes();

        } catch (error) {
            console.error('Ê∏ÖÁ©∫Â§±Ë¥•:', error);
            showError('Ê∏ÖÁ©∫Â§±Ë¥•: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // Ê†ºÂºèÂåñÊó∂Èó¥Êà≥
    function formatTimestamp(timestamp) {
        if (!timestamp) return 'Êú™Áü•';
        try {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        } catch (e) {
            return 'Êó†ÊïàÊó∂Èó¥';
        }
    }

    // Èò≤ÊäñÂáΩÊï∞
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // ÊòæÁ§∫/ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
    function showLoading(show) {
        const buttons = document.querySelectorAll('button');
        buttons.forEach(btn => {
            btn.disabled = show;
        });
    }

    // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
    function showError(message) {
        hideMessages();
        const errorElement = document.getElementById('error');
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.textContent = message;
        errorElement.style.display = 'flex';

        setTimeout(() => {
            errorElement.style.display = 'none';
        }, 5000);
    }

    // ÊòæÁ§∫ÊàêÂäü‰ø°ÊÅØ
    function showSuccess(message) {
        hideMessages();
        const successElement = document.getElementById('success');
        const successMessage = document.getElementById('successMessage');
        successMessage.textContent = message;
        successElement.style.display = 'flex';

        setTimeout(() => {
            successElement.style.display = 'none';
        }, 3000);
    }

    // ÈöêËóèÊâÄÊúâÊ∂àÊÅØ
    function hideMessages() {
        document.getElementById('error').style.display = 'none';
        document.getElementById('success').style.display = 'none';
    }
</script>
</body>
</html>